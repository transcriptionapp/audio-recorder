<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcription Editor</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 50px; }
        #status { font-size: 20px; font-weight: bold; }
        #transcriptionText { width: 90%; height: 200px; font-size: 16px; display: none; }
        #editBtn, #saveBtn { font-size: 16px; padding: 10px; cursor: pointer; margin: 10px; display: none; }
    </style>
</head>
<body>
    <h1>Step 3</h1>
    <p id="status">Fetching your transcription...</p>
    <textarea id="transcriptionText" disabled></textarea><br>
    <button id="editBtn">Edit</button>
    <button id="saveBtn">Save</button>

    <script>
        const airtableFetchURL = "https://api.airtable.com/v0/appcQRU8kU0f9xO9l/Free_Transcription_Usage%20Table";
        const airtableUpdateURL = "https://api.airtable.com/v0/appcQRU8kU0f9xO9l/Free_Transcription_Usage%20Table";
        const apiKey = "Bearer patPkh6EP9sLPayyv.a38f354cb915127b08cc3d128282be41bf94fba0169eca7ef91ed785a80d83f4"; // Secure this in a backend

        let recordingId = ""; // Will be assigned after fetching

        async function fetchTranscription() {
            try {
                const response = await fetch(`${airtableFetchURL}?filterByFormula={user_id}='admin'&sort[0][field]=timestamp&sort[0][direction]=desc&maxRecords=1`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    }
                });

                const data = await response.json();
                if (data.records.length > 0) {
                    let record = data.records[0];
                    recordingId = record.fields.recording_id;
                    document.getElementById("status").innerText = "Transcription Loaded!";
                    document.getElementById("transcriptionText").value = record.fields.transcription;
                    document.getElementById("transcriptionText").style.display = "block";
                    document.getElementById("editBtn").style.display = "inline";
                } else {
                    document.getElementById("status").innerText = "No transcription found!";
                }
            } catch (error) {
                console.error("Fetch error:", error);
                document.getElementById("status").innerText = "Failed to load transcription.";
            }
        }

        document.getElementById("editBtn").addEventListener("click", function() {
            document.getElementById("transcriptionText").disabled = false;
            document.getElementById("editBtn").style.display = "none";
            document.getElementById("saveBtn").style.display = "inline";
        });

        document.getElementById("saveBtn").addEventListener("click", async function() {
            let updatedText = document.getElementById("transcriptionText").value;

            try {
                let response = await fetch(airtableUpdateURL, {
                    method: "PATCH",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        records: [{
                            id: recordingId,
                            fields: {
                                edited_text: updatedText,
                                is_edited: true
                            }
                        }]
                    })
                });

                if (response.ok) {
                    document.getElementById("status").innerText = "Transcription saved successfully!";
                    document.getElementById("transcriptionText").disabled = true;
                    document.getElementById("editBtn").style.display = "inline";
                    document.getElementById("saveBtn").style.display = "none";
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                console.error("Save error:", error);
                document.getElementById("status").innerText = "Failed to save transcription.";
            }
        });

        fetchTranscription();
    </script>
</body>
</html>
